<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>全国 TCPing 地图</title>
    <!-- Include ECharts and China map -->
    <script src="echarts.min.js"></script>
    <script src="china.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #f8fafc;
        overflow: hidden;
      }

      #map {
        width: 100vw;
        height: 100vh;
        background-color: #f8fafc;
      }

      /* Info Panel Styles */
      #info-box {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 320px;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.3s ease-in-out;
        z-index: 20;
      }

      #info-box.collapsed {
        transform: translateY(0%);
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: linear-gradient(to right, #3b82f6, #2563eb);
        color: white;
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      .info-header h3 {
        font-size: 1rem;
        font-weight: 500;
      }

      .toggle-button {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        color: inherit;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .toggle-button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .toggle-button.dark {
        color: #64748b;
      }

      .toggle-button.dark:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #1e293b;
      }

      #info-content {
        padding: 1rem;
        max-height: 70vh;
        overflow-y: auto;
        transition: max-height 0.3s ease-in-out;
      }

      #info-content.collapsed {
        max-height: 0;
        padding: 0;
        overflow: hidden;
      }

      /* Server Selector Styles */
      #server-selector {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.3s ease-in-out;
        z-index: 20;
        width: 240px;
      }

      #server-selector.collapsed {
        transform: translateX(-120%);
      }

      .server-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e7eb;
      }

      .server-header h3 {
        font-size: 1rem;
        font-weight: 500;
        color: #1f2937;
      }

      .server-list {
        padding: 0.75rem;
      }

      .server-item {
        width: 100%;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.375rem;
        text-align: left;
        font-size: 0.875rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        background-color: #f3f4f6;
        color: #4b5563;
      }

      .server-item:hover {
        background-color: #e5e7eb;
      }

      .server-item.selected {
        background-color: #dbeafe;
        color: #1d4ed8;
        font-weight: 500;
      }

      /* Toggle Button Styles */
      #toggle-server-button {
        position: absolute;
        top: 1rem;
        left: 1rem;
        z-index: 30;
        padding: 0.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
        display: none;
      }

      #toggle-server-button:hover {
        background-color: #f3f4f6;
      }

      #toggle-server-button.visible {
        display: block;
      }

      /* Loading Indicator */
      .loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }

      .loading-content {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .loading-spinner {
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* Last update time display */
      #last-update {
        position: absolute;
        left: 1rem;
        bottom: 1rem;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 0.875rem;
        color: #64748b;
        z-index: 20;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      #last-update::before {
        content: "";
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
      }

      /* Scrollbar Styles */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Latency Colors */
      .latency-good { color: #059669; }
      .latency-medium { color: #d97706; }
      .latency-high { color: #dc2626; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    
    <!-- Info Panel -->
    <div id="info-box">
      <div class="info-header">
        <h3 id="info-title">全国详细信息</h3>
        <button class="toggle-button" onclick="toggleInfoPanel()">
          <span class="toggle-icon">▼</span>
        </button>
      </div>
      <div id="info-content"></div>
    </div>

    <!-- Server Selector -->
    <div id="server-selector">
      <div class="server-header">
        <h3>服务器列表</h3>
        <button class="toggle-button dark" onclick="toggleServerSelector()">
          <span class="toggle-icon">←</span>
        </button>
      </div>
      <div class="server-list" id="server-list"></div>
    </div>

    <!-- Toggle Server Button -->
    <button id="toggle-server-button" onclick="showServerSelector()">☰</button>

    <!-- Last Update Time -->
    <div id="last-update" style="margin-left: 50px;">
      更新时间: <span id="update-time">--:--:--</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay" style="display: none;">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <span>加载中...</span>
      </div>
    </div>

    <script>
      let chartDom = document.getElementById('map');
      let myChart = echarts.init(chartDom);
      let detailedData = {};
      let lastClickedProvince = null;
      let currentServer = null;
      let isInfoCollapsed = false;
      let isServerCollapsed = false;

      const servers = [
        { name: "ClawCloud HK CN-Opt", ip: "https://hk.cnopt.clawcloud.tcpingmap.aunet.dpdns.org" },
        { name: "ClawCloud JP INTL", ip: "https://jp.intl.clawcloud.tcpingmap.aunet.dpdns.org" },
        { name: "Sharon HK Premium", ip: "https://hkg.pre.sharon.tcpingmap.aunet.dpdns.org" },
        { name: "Sharon SG Premium", ip: "https://sin.pre.sharon.tcpingmap.aunet.dpdns.org" },
        { name: "Sharon JP Premium", ip: "https://jpn.pre.sharon.tcpingmap.aunet.dpdns.org" },
        { name: "Sharon KR Premium", ip: "https://kor.pre.sharon.tcpingmap.aunet.dpdns.org" }
      ];

      function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        document.getElementById('update-time').textContent = timeString;
      }

      function toggleInfoPanel() {
        const infoBox = document.getElementById('info-box');
        const content = document.getElementById('info-content');
        const button = document.querySelector('#info-box .toggle-icon');
        
        isInfoCollapsed = !isInfoCollapsed;
        
        if (isInfoCollapsed) {
          infoBox.classList.add('collapsed');
          content.classList.add('collapsed');
          button.textContent = '▼';
        } else {
          infoBox.classList.remove('collapsed');
          content.classList.remove('collapsed');
          button.textContent = '▲';
        }
      }

      function toggleServerSelector() {
        const selector = document.getElementById('server-selector');
        const toggleButton = document.getElementById('toggle-server-button');
        
        isServerCollapsed = true;
        selector.classList.add('collapsed');
        toggleButton.classList.add('visible');
      }

      function showServerSelector() {
        const selector = document.getElementById('server-selector');
        const toggleButton = document.getElementById('toggle-server-button');
        
        isServerCollapsed = false;
        selector.classList.remove('collapsed');
        toggleButton.classList.remove('visible');
      }

      function renderServerList() {
        const serverList = document.getElementById('server-list');
        serverList.innerHTML = servers.map(server => `
          <button
            class="server-item ${currentServer === server.ip ? 'selected' : ''}"
            onclick="switchServer('${server.ip}')"
          >
            ${server.name}
          </button>
        `).join('');
      }

      function switchServer(ip) {
        currentServer = ip;
        renderServerList();
        fetchData();
      }

      function getLatencyClass(latency) {
        if (latency < 100) return 'latency-good';
        if (latency < 200) return 'latency-medium';
        return 'latency-high';
      }

      async function fetchData() {
        if (!currentServer) return;
        
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        try {
          const response = await fetch(`${currentServer}/get_results`);
          const data = await response.json();
          
          const provinceData = {};
          detailedData = {};
          
          for (const key in data) {
            const [province, cityOperator] = key.split("-");
            const { average_delay } = data[key];
            
            if (!provinceData[province]) {
              provinceData[province] = { totalDelay: 0, totalCount: 0 };
            }
            
            provinceData[province].totalDelay += average_delay || 0;
            provinceData[province].totalCount += 1;
            
            if (!detailedData[province]) {
              detailedData[province] = [];
            }
            
            detailedData[province].push({
              name: cityOperator,
              average_delay
            });
          }
          
          const mapData = Object.keys(provinceData).map(province => ({
            name: province,
            value: provinceData[province].totalDelay / provinceData[province].totalCount || null
          }));
          
          updateChart(mapData);
          updateInfoPanel();
          updateLastUpdateTime();
        } catch (error) {
          console.error('Error fetching data:', error);
        } finally {
          loading.style.display = 'none';
        }
      }

      function updateChart(mapData) {
        const option = {
          tooltip: {
            trigger: 'item',
            formatter: function (params) {
              const province = params.name;
              return `<strong>${province}</strong><br>平均延迟: ${params.value ? `${params.value.toFixed(2)} ms` : '暂无数据'}`;
            }
          },
          visualMap: {
            min: 0,
            max: 300,
            left: 'left',
            bottom: 30,
            text: ['高延迟', '低延迟'],
            calculable: true,
            inRange: {
              color: ['#31c27c', '#ffeb3b', '#f44336']
            },
            textStyle: {
              color: '#333'
            }
          },
          series: [{
            name: 'Ping延迟',
            type: 'map',
            map: 'china',
            roam: true,
            emphasis: {
              label: {
                show: true,
                color: '#333'
              },
              itemStyle: {
                areaColor: '#b8e0f6'
              }
            },
            label: {
              show: true,
              color: '#333',
              fontSize: 10
            },
            itemStyle: {
              areaColor: '#e0e8f0',
              borderColor: '#ccc'
            },
            data: mapData
          }]
        };
        
        myChart.setOption(option);
        
        myChart.off('click');
        myChart.on('click', function(params) {
          handleProvinceClick(params.name);
        });
      }

      function handleProvinceClick(province) {
        if (province === lastClickedProvince) {
          lastClickedProvince = null;
          document.getElementById('info-title').innerText = '全国详细信息';
        } else if (detailedData[province]) {
          lastClickedProvince = province;
          document.getElementById('info-title').innerText = `${province}详细信息`;
          if (isInfoCollapsed) {
            toggleInfoPanel();
          }
        } else {
          lastClickedProvince = null;
          document.getElementById('info-title').innerText = '全国详细信息';
        }
        
        updateInfoPanel();
      }

      function updateInfoPanel() {
        const content = document.getElementById('info-content');
        
        if (lastClickedProvince && detailedData[lastClickedProvince]) {
          content.innerHTML = detailedData[lastClickedProvince].map(item => `
            <div style="background: white; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0.375rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);">
              <div style="font-weight: 500; color: #1f2937;">${item.name}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">
                平均延迟: <span class="${getLatencyClass(item.average_delay)}">${item.average_delay} ms</span>
              </div>
            </div>
          `).join('');
        } else {
          content.innerHTML = Object.keys(detailedData).map(province => `
            <div style="margin-bottom: 1rem;">
              <h4 style="font-weight: 500; color: #1f2937; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">
                ${province}
              </h4>
              <div style="margin-left: 0.5rem;">
                ${detailedData[province].map(item => `
                  <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                    <span style="color: #4b5563;">${item.name}:</span>
                    <span class="${getLatencyClass(item.average_delay)}">${item.average_delay} ms</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('');
        }
      }

      window.addEventListener('resize', function() {
        myChart.resize();
      });

      // Initialize
      window.onload = function() {
        if (servers.length > 0) {
          currentServer = servers[0].ip;
          renderServerList();
          fetchData();
          setInterval(fetchData, 90000);
        }
      };
    </script>
  </body>
</html>
