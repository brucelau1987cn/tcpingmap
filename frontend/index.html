<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全国三网 TCPing 延迟地图</title>
    <!-- 引入 ECharts 和中国地图 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/china.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #e0e8f0; /* 蓝灰色背景 */
            overflow: hidden; /* 防止滚动条出现 */
        }
        #map {
            width: 100vw; /* 占满整个视口宽度 */
            height: 100vh; /* 占满整个视口高度 */
            border: none; /* 移除边框 */
            box-shadow: none; /* 移除阴影 */
        }
        #info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            width: 300px;
            max-height: 90vh;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #333;
            transition: max-height 0.5s ease-in-out; /* 添加过渡动画 */
        }
        #info-box h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }
        #info-content {
            max-height: 70vh;
            overflow-y: auto;
            transition: max-height 0.5s ease-in-out; /* 添加过渡动画 */
        }
        #info-box p {
            margin: 5px 0;
        }
        #toggle-button {
            display: block;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            color: #007bff;
            font-size: 14px;
        }
        #toggle-button:hover {
            color: #0056b3;
        }
        /* 新增：服务器选择悬浮框 */
        #server-selector {
            position: fixed;
            bottom: 60px; /* 向上移动，避免与按钮重叠 */
            right: 10px;
            z-index: 1000;
            width: 250px;
            max-height: 90vh;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: #333;
            display: block; /* 默认展开 */
            transition: max-height 0.5s ease-in-out; /* 添加过渡动画 */
        }
        #server-selector h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
            text-align: center; /* 标题居中 */
        }
        #server-list {
            max-height: 60vh;
            overflow-y: auto;
            text-align: center; /* 内容居中 */
        }
        .server-item {
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .server-item.selected {
            font-weight: bold;
            color: #007bff;
        }
        /* 悬浮框展开/隐藏按钮 */
        #toggle-server-selector {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1001;
            background-color: #007bff;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #toggle-server-selector:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <!-- 悬浮框 -->
    <div id="info-box">
        <h3 id="info-title">全国 详细信息</h3>
        <div id="info-content"></div>
        <div id="toggle-button">收起详细信息 ▲</div>
    </div>
    <!-- 服务器选择悬浮框 -->
    <div id="server-selector">
        <h3>服务器列表</h3>
        <div id="server-list">
            <!-- 动态生成服务器列表 -->
        </div>
    </div>
    <!-- 展开/隐藏按钮 -->
    <button id="toggle-server-selector">隐藏服务器列表</button>
    <script>
        var chartDom = document.getElementById('map');
        var myChart = echarts.init(chartDom);
        let detailedData = {}; // 存储所有省份的详细数据
        let lastClickedProvince = null; // 记录上一次点击的省份
        let currentServer = null; // 当前选中的服务器
        // 定义所有数据源
        const servers = [
            { name: "Example A", ip: "http://a.example.com:5000" },
            { name: "Example B", ip: "http://b.example.com:5000" },
            { name: "Example C", ip: "http://c.example.com:5000" }
        ];
        // 渲染服务器列表
        function renderServerList() {
            const serverList = document.getElementById('server-list');
            serverList.innerHTML = '';
            servers.forEach(server => {
                const item = document.createElement('div');
                item.className = 'server-item';
                item.textContent = server.name; // 只显示服务器备注
                if (currentServer === server.ip) {
                    item.classList.add('selected'); // 高亮当前选中的服务器
                }
                item.onclick = () => switchServer(server.ip);
                serverList.appendChild(item);
            });
        }
        // 切换服务器
        function switchServer(ip) {
            currentServer = ip;
            fetchData();
            renderServerList(); // 重新渲染服务器列表以更新高亮状态
        }
        // 获取并绘制 Ping 延迟数据
        function fetchData() {
            if (!currentServer) return;
            fetch(`${currentServer}/get_results`)
                .then(response => response.json())
                .then(data => {
                    const provinceData = {};
                    detailedData = {};
                    for (const key in data) {
                        const [province, cityOperator] = key.split("-"); // 分离省份和城市+运营商
                        const { average_delay } = data[key];
                        if (!provinceData[province]) {
                            provinceData[province] = { totalDelay: 0, totalCount: 0 };
                        }
                        // 累加延迟值并计数
                        provinceData[province].totalDelay += average_delay || 0;
                        provinceData[province].totalCount += 1;
                        // 存储详细数据
                        if (!detailedData[province]) {
                            detailedData[province] = [];
                        }
                        detailedData[province].push({
                            name: cityOperator,
                            average_delay
                        });
                    }
                    // 计算每个省份的平均延迟
                    const mapData = Object.keys(provinceData).map(province => ({
                        name: province,
                        value: provinceData[province].totalDelay / provinceData[province].totalCount || null
                    }));
                    // 绘制地图
                    var option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: function (params) {
                                const province = params.name;
                                if (detailedData[province]) {
                                    let tooltipContent = `<strong>${province}</strong><br>`;
                                    detailedData[province].forEach(item => {
                                        tooltipContent += `${item.name}: 平均延迟 ${item.average_delay} ms<br>`;
                                    });
                                    return tooltipContent;
                                }
                                return `${province}: 数据不可用`;
                            }
                        },
                        visualMap: {
                            min: 0,
                            max: 300,
                            left: 'left',
                            top: 'bottom',
                            text: ['高延迟', '低延迟'],
                            calculable: true,
                            inRange: {
                                color: ['#31c27c', '#ffeb3b', '#f44336'] // 绿色 -> 黄色 -> 红色
                            }
                        },
                        series: [{
                            name: 'Ping 延迟',
                            type: 'map',
                            mapType: 'china',
                            roam: true, // 允许缩放和平移
                            label: {
                                show: true,
                                color: '#333',
                                fontSize: 10
                            },
                            itemStyle: {
                                areaColor: 'grey', // 默认省份区域灰色
                                borderColor: '#ccc'       // 区域边界颜色
                            },
                            data: mapData
                        }]
                    };
                    myChart.setOption(option);
                    // 添加点击事件
                    myChart.on('click', function (params) {
                        const province = params.name;
                        if (province === lastClickedProvince) {
                            // 反选省份时，恢复全国数据
                            document.getElementById('info-title').innerText = '全国 详细信息';
                            document.getElementById('info-content').innerHTML = generateDefaultContent();
                            lastClickedProvince = null; // 清空记录
                        } else if (detailedData[province]) {
                            // 更新悬浮框内容
                            document.getElementById('info-title').innerText = `${province} 详细信息`;
                            // 构建详细内容
                            let content = '';
                            detailedData[province].forEach(item => {
                                content += `<p><strong>${item.name}</strong>: 平均延迟 ${item.average_delay} ms</p>`;
                            });
                            document.getElementById('info-content').innerHTML = content;
                            // 更新记录
                            lastClickedProvince = province;
                        } else {
                            // 如果没有数据，保持默认显示
                            document.getElementById('info-title').innerText = '全国 详细信息';
                            document.getElementById('info-content').innerHTML = generateDefaultContent();
                            lastClickedProvince = null; // 清空记录
                        }
                        // 自动展开详细信息
                        document.getElementById('info-content').style.display = 'block';
                        document.getElementById('toggle-button').innerText = '收起详细信息 ▲';
                    });
                    // 页面加载时默认显示全国数据
                    document.getElementById('info-title').innerText = '全国 详细信息';
                    document.getElementById('info-content').innerHTML = generateDefaultContent();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
        // 生成全国数据的默认内容
        function generateDefaultContent() {
            let content = '';
            for (const province in detailedData) {
                content += `<p><strong>${province}</strong>:</p>`;
                detailedData[province].forEach(item => {
                    content += `<p>&nbsp;&nbsp;${item.name}: 平均延迟 ${item.average_delay} ms</p>`;
                });
            }
            return content || '<p>暂无数据</p>';
        }
        // 初始化加载数据
        window.onload = function () {
            // 默认选择第一个服务器
            if (servers.length > 0) {
                currentServer = servers[0].ip;
            }
            renderServerList();
            fetchData();
            setInterval(fetchData, 30000); // 每 30 秒刷新一次数据
            // 展开/收起按钮逻辑
            document.getElementById('toggle-button').addEventListener('click', function () {
                const content = document.getElementById('info-content');
                const button = document.getElementById('toggle-button');
                if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = '0px'; // 收起
                    button.innerText = '展开详细信息 ▼';
                } else {
                    content.style.maxHeight = '70vh'; // 展开
                    button.innerText = '收起详细信息 ▲';
                }
            });
            // 服务器悬浮框展开/隐藏按钮逻辑
            const toggleButton = document.getElementById('toggle-server-selector');
            const serverSelector = document.getElementById('server-selector');
            toggleButton.addEventListener('click', function () {
                if (serverSelector.style.maxHeight && serverSelector.style.maxHeight !== '0px') {
                    serverSelector.style.maxHeight = '0px'; // 收起
                    toggleButton.innerText = '显示服务器列表';
                } else {
                    serverSelector.style.maxHeight = '90vh'; // 展开
                    toggleButton.innerText = '隐藏服务器列表';
                }
            });
        };
        // 自适应窗口大小
        window.addEventListener('resize', function () {
            myChart.resize();
        });
    </script>
</body>
</html>
